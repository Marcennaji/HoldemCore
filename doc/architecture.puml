@startuml
title HoldemCore – Hexagonal Architecture with AppFactory Composition Root

skinparam packageStyle rectangle
skinparam shadowing false
skinparam componentStyle rectangle

package "Core (Domain)" as Core #LightYellow {
  [Engine] as Engine
  [GameEvents] as GameEvents
  [Session] as Session
  [EngineFactory] as EngineFactory
  [Player (Facade)] as Player
  [PlayerFactory] as PlayerFactory
  [Hand (Facade)] as Hand
  [Interfaces/Ports] as Ports
}

package "Application (Composition Root)" as App #LightBlue {
  [main_qt_widgets.cpp] as Main
  [AppFactory] as AppFactory
  [GuiAppController] as GuiController
}

package "Infrastructure (Secondary Adapters)" as Infra #LightGreen {
  [ConsoleLogger] as ConsoleLogger
  [SqlitePlayersStatisticsStore] as SqliteStore
  [PsimHandEvaluationEngine] as PsimEngine
  [DefaultRandomizer] as DefaultRandomizer
  [SqliteDb] as SqliteDb
}

package "UI (Primary Adapters)" as UI #LightCyan {
  [StartWindow] as StartWindow
  [PokerTableWindow] as TableWindow
  [GuiBridgeWidgets] as Bridge
}

package "Third-party" as ThirdParty #LightGray {
  [SQLite3] as SQLite3
  [psim] as psim
  [Qt6] as Qt6
  [GoogleTest] as GoogleTest
}

' Core Domain Relationships
Ports -[#0000FF]-> Engine : defines contracts
GameEvents -[#0000FF]-> Session : event system
Session -[#green]-> EngineFactory : uses
Session -[#green]-> PlayerFactory : creates
EngineFactory -[#green]-> Hand : creates
EngineFactory -[#green]-> Engine : creates
PlayerFactory -[#green]-> Player : creates
Engine -[#green]-> Ports : depends on
Hand -[#green]-> Ports : depends on
Player -[#green]-> Ports : depends on
Session -[#green]-> Ports : depends on
EngineFactory -[#green]-> Ports : depends on
PlayerFactory -[#green]-> Ports : depends on

' Application Layer (Composition Root via AppFactory)
Main -[#red]-> AppFactory : delegates to factory
AppFactory -[#red]-> Infra : creates concrete adapters
AppFactory -[#red]-> GuiController : injects adapters via constructor
GuiController -[#red]-> Session : creates with injected deps
GuiController -[#red]-> EngineFactory : creates with injected deps
GuiController -[#red]-> UI : creates

' Secondary Adapters (implement core interfaces - driven by application)
ConsoleLogger -[#orange]-> Ports : implements Logger
SqliteStore -[#orange]-> Ports : implements PlayersStatisticsStore  
PsimEngine -[#orange]-> Ports : implements HandEvaluationEngine
DefaultRandomizer -[#orange]-> Ports : implements Randomizer
SqliteStore -[#orange]-> SqliteDb : uses

' Primary Adapters (drive the application - user interfaces)
UI -[#purple]-> GameEvents : subscribes to
StartWindow -[#purple]-> Session : drives application
Bridge -[#purple]-> GameEvents : handles events
Bridge -[#purple]-> TableWindow : updates UI

' Third-party Dependencies
SqliteDb -[#gray]-> SQLite3 : uses
PsimEngine -[#gray]-> psim : uses  
UI -[#gray]-> Qt6 : framework

' AppFactory Composition Root Pattern
note right of Main : Clean Entry Point:\n• No concrete dependencies\n• Delegates to AppFactory\n• Single responsibility
note right of AppFactory : Composition Root:\n• Creates all concrete adapters\n• Configurable implementations\n• Pure dependency injection\n• Single point of change
note bottom of Ports : Abstract Interfaces:\n• Logger\n• HandEvaluationEngine\n• PlayersStatisticsStore\n• Randomizer
note bottom of Core : Pure Domain Logic:\n• Zero infrastructure knowledge\n• All dependencies injected\n• Constructor injection only\n• Facades coordinate components
note left of Core : Hand Facade:\nDelegates to 6 managers:\n• HandPlayersManager\n• HandActionHandler\n• HandCardDealer\n• HandCalculator\n• HandStateManager\n• HandLifecycleManager\n\nPlayer Facade:\nDelegates to:\n• PlayerStrategy\n• PlayerStatisticsUpdater\n• RangeEstimator\n• CurrentHandContext
note left of UI : Primary Adapters:\n• Drive the application\n• User interfaces\n• Trigger use cases
note right of Infra : Secondary Adapters:\n• Driven by application\n• Implement core interfaces\n• Infrastructure concerns

@enduml
